<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>–ë—É—Ä—è –û—Ä–ª–æ–≤</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#000;touch-action:none;font-family:'Segoe UI',Arial,sans-serif}
canvas{display:block;position:fixed;top:0;left:0}

/* ‚îÄ‚îÄ –ü–û–í–ï–†–ù–£–¢–¨ –≠–ö–†–ê–ù ‚îÄ‚îÄ */
#rotate{display:none;position:fixed;inset:0;z-index:9999;background:#05080f;
  flex-direction:column;align-items:center;justify-content:center;gap:20px;text-align:center}
#rotate-icon{font-size:72px;animation:rtilt 1.5s ease-in-out infinite alternate}
@keyframes rtilt{from{transform:rotate(-30deg)}to{transform:rotate(30deg)}}
#rotate p{color:#f1c40f;font-size:20px;font-weight:700;letter-spacing:2px;padding:0 20px}

/* ‚îÄ‚îÄ –ú–ï–ù–Æ –í–´–ë–û–†–ê –ü–¢–ò–¶–´ ‚Äî –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ ‚îÄ‚îÄ */
#menu{position:fixed;inset:0;z-index:500;background:rgba(3,6,18,.95);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;padding:16px}

.sel-title{font-size:clamp(28px,6vw,48px);font-weight:900;letter-spacing:3px;
  background:linear-gradient(135deg,#f1c40f,#e67e22);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:4px;text-align:center}
.sel-sub{font-size:12px;letter-spacing:5px;color:rgba(255,255,255,.35);margin-bottom:16px;text-align:center}

.sel-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
  width:100%;max-width:680px;margin-bottom:16px}
.sel-card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.12);
  border-radius:14px;padding:10px 6px 8px;cursor:pointer;transition:.2s;text-align:center}
.sel-card:hover:not(.locked){border-color:rgba(241,196,15,.7);transform:translateY(-3px)}
.sel-card.active{border-color:#f1c40f;background:rgba(241,196,15,.1)}
.sel-card.locked{border-color:rgba(255,255,255,.05);opacity:.7}
.sel-card canvas{display:block;margin:0 auto 6px;width:54px;height:54px}
.sel-card .cname{font-size:11px;font-weight:700;letter-spacing:1px;color:rgba(255,255,255,.7)}
.sel-card.active .cname{color:#f1c40f}
.sel-card .ctag{font-size:9px;color:rgba(255,255,255,.3);margin-top:2px}

.sel-name-row{display:flex;gap:10px;align-items:center;margin-bottom:14px;width:100%;max-width:500px}
.sel-name-row input{flex:1;padding:12px 16px;border-radius:10px;
  border:2px solid rgba(241,196,15,.3);background:rgba(255,255,255,.07);
  color:#fff;font-size:16px;font-weight:700;outline:none;text-align:center;
  font-family:inherit;transition:.2s}
.sel-name-row input:focus{border-color:#f1c40f;box-shadow:0 0 14px rgba(241,196,15,.25)}
.sel-name-row input::placeholder{color:rgba(255,255,255,.3)}

.sel-btns{display:flex;gap:12px;width:100%;max-width:500px}
.btn-play{flex:2;padding:15px;border:none;border-radius:12px;
  background:linear-gradient(135deg,#f1c40f,#e67e22);
  color:#000;font-size:18px;font-weight:900;letter-spacing:2px;cursor:pointer;transition:.2s}
.btn-play:hover{transform:scale(1.03);box-shadow:0 0 24px rgba(241,196,15,.5)}
.btn-play:active{transform:scale(.97)}
.btn-anon{flex:1;padding:15px;border:1px solid rgba(255,255,255,.2);border-radius:12px;
  background:rgba(255,255,255,.07);color:rgba(255,255,255,.7);
  font-size:14px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:.2s}
.btn-anon:hover{background:rgba(255,255,255,.14)}

/* ‚îÄ‚îÄ GAME OVER ‚Äî –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ ‚îÄ‚îÄ */
#gameover{position:fixed;inset:0;z-index:500;display:none;
  background:rgba(3,6,18,.93);backdrop-filter:blur(12px);
  flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px}
.go-title{font-size:clamp(36px,9vw,64px);font-weight:900;
  color:#e74c3c;text-shadow:0 0 30px rgba(231,76,60,.7)}
.go-score{font-size:clamp(24px,5vw,40px);font-weight:900;color:#f1c40f}
.go-best{font-size:13px;color:rgba(255,255,255,.4);letter-spacing:2px}
.go-lb{width:100%;max-width:440px;background:rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden}
.go-lb-head{padding:8px 14px;background:rgba(241,196,15,.08);
  font-size:11px;letter-spacing:4px;color:#f1c40f;font-weight:700;
  border-bottom:1px solid rgba(241,196,15,.12)}
.lb-row{display:flex;align-items:center;gap:8px;padding:7px 14px;
  border-bottom:1px solid rgba(255,255,255,.04);font-size:13px;font-weight:600}
.lb-row:last-child{border-bottom:none}
.lb-me{background:rgba(241,196,15,.07)}
.lb-rank{width:22px;font-size:15px;text-align:center}
.lb-icon{font-size:16px}
.lb-name{flex:1;color:rgba(255,255,255,.8)}
.lb-name.me{color:#f1c40f}
.lb-pts{color:#f1c40f;font-weight:900;font-size:15px}
.go-btns{display:flex;gap:12px}
.btn-again{padding:14px 32px;border:none;border-radius:12px;
  background:linear-gradient(135deg,#2ecc71,#16a085);
  color:#fff;font-size:16px;font-weight:900;letter-spacing:2px;cursor:pointer;transition:.2s}
.btn-again:hover{transform:scale(1.04)}
.btn-again:active{transform:scale(.96)}
.btn-back{padding:14px 24px;border:1px solid rgba(255,255,255,.2);border-radius:12px;
  background:rgba(255,255,255,.08);color:#fff;font-size:16px;font-weight:700;
  letter-spacing:1px;cursor:pointer;transition:.2s}
.btn-back:hover{background:rgba(255,255,255,.15)}
.btn-back:active{transform:scale(.96)}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
#hud{position:fixed;top:0;left:0;right:0;z-index:100;pointer-events:none;
  display:none;align-items:flex-start;justify-content:space-between;padding:10px 18px}
#hud-score{font-size:clamp(30px,6vw,52px);font-weight:900;
  color:#f1c40f;text-shadow:0 0 18px rgba(241,196,15,.8),0 2px 4px #000;line-height:1}
#hud-label{font-size:10px;letter-spacing:3px;color:rgba(255,255,255,.4);margin-top:2px}
#hud-combo{font-size:clamp(14px,2.5vw,22px);color:#e74c3c;font-weight:900;
  text-shadow:0 0 12px rgba(231,76,60,.9);opacity:0;transition:opacity .3s;text-align:right}
#speedbar{position:fixed;bottom:0;left:0;right:0;height:4px;z-index:100;
  background:rgba(255,255,255,.1);display:none}
#speedbar-fill{height:100%;width:0%;background:linear-gradient(90deg,#2ecc71,#f1c40f,#e74c3c);transition:width .5s}

@media(max-width:600px){
  .sel-grid{gap:7px}
  .sel-card canvas{width:44px;height:44px}
  .sel-btns{flex-direction:column}
  .go-btns{flex-direction:column;width:100%;max-width:300px}
  .btn-again,.btn-back{width:100%}
}
@media(max-height:400px){
  .sel-card{padding:6px 4px 4px}
  .sel-card canvas{width:38px;height:38px}
  .sel-sub{margin-bottom:8px}
  .sel-name-row{margin-bottom:8px}
}
</style>
</head>
<body>

<div id="rotate">
  <div id="rotate-icon">üì±</div>
  <p>–ü–û–í–ï–†–ù–ò –¢–ï–õ–ï–§–û–ù<br>–ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û</p>
</div>

<!-- –ì–õ–ê–í–ù–´–ô CANVAS ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã -->
<canvas id="c"></canvas>

<!-- –ú–ï–ù–Æ –í–´–ë–û–†–ê –ü–¢–ò–¶–´ -->
<div id="menu">
  <div class="sel-title">ü¶Ö –ë–£–†–Ø –û–†–õ–û–í</div>
  <div class="sel-sub">–í–´–ë–ï–†–ò –ü–¢–ò–¶–£ ‚Äî –õ–ï–¢–ò ‚Äî –ü–û–ë–ï–ñ–î–ê–ô</div>
  <div class="sel-grid" id="sel-grid"></div>
  <div class="sel-name-row">
    <input type="text" id="inp-name" placeholder="–í–≤–µ–¥–∏ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
           maxlength="12" autocomplete="off" autocorrect="off" spellcheck="false">
  </div>
  <div class="sel-btns">
    <button class="btn-play" onclick="clickPlay()">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
    <button class="btn-anon" onclick="clickAnon()">–ë–µ–∑ –∏–º–µ–Ω–∏</button>
  </div>
</div>

<!-- GAME OVER -->
<div id="gameover">
  <div class="go-title">üí• –ö–†–£–®–ï–ù–ò–ï!</div>
  <div class="go-score" id="go-score">0 –û–ß–ö–û–í</div>
  <div class="go-best"  id="go-best"></div>
  <div class="go-lb">
    <div class="go-lb-head">üèÜ –¢–ê–ë–õ–ò–¶–ê –†–ï–ö–û–†–î–û–í</div>
    <div id="lb-rows"></div>
  </div>
  <div class="go-btns">
    <button class="btn-again" onclick="clickAgain()">‚Üª –ï–©–Å –†–ê–ó</button>
    <button class="btn-back"  onclick="clickMenu()">‚åÇ –ú–ï–ù–Æ</button>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div>
    <div id="hud-score">0</div>
    <div id="hud-label">–û–ß–ö–ò</div>
  </div>
  <div id="hud-combo"></div>
</div>
<div id="speedbar"><div id="speedbar-fill"></div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ü–¢–ò–¶–´
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BIRDS=[
  {id:'eagle',  name:'–û–†–Å–õ',      tag:'–ö–õ–ê–°–°–ò–ö–ê', emoji:'ü¶Ö',body:'#5d4037',wing:'#3e2723',head:'#fff8e1',beak:'#f59e0b',eye:'#111',  aura:null,       trail:'rgba(139,90,43,.4)'},
  {id:'phoenix',name:'–§–ï–ù–ò–ö–°',    tag:'–û–ì–û–ù–¨',    emoji:'üî•',body:'#e74c3c',wing:'#922b21',head:'#f39c12',beak:'#e67e22',eye:'#fff',  aura:'#ff6b35',  trail:'rgba(231,76,60,.5)'},
  {id:'raven',  name:'–í–û–†–û–ù',     tag:'–¢–ï–ù–¨',     emoji:'üê¶',body:'#1a1a2e',wing:'#0d0d1a',head:'#2c2c54',beak:'#95a5a6',eye:'#6c5ce7',aura:'#6c5ce7', trail:'rgba(108,92,231,.4)'},
  {id:'falcon', name:'–°–û–ö–û–õ',     tag:'–°–ö–û–†–û–°–¢–¨', emoji:'ü¶Ö',body:'#2c3e50',wing:'#1a252f',head:'#ecf0f1',beak:'#e67e22',eye:'#e74c3c',aura:'#3498db', trail:'rgba(52,73,94,.4)'},
  {id:'parrot', name:'–ü–û–ü–£–ì–ê–ô',   tag:'–£–î–ê–ß–ê',    emoji:'ü¶ú',body:'#27ae60',wing:'#1e8449',head:'#f1c40f',beak:'#e74c3c',eye:'#fff',  aura:'#f1c40f',  trail:'rgba(39,174,96,.4)'},
  {id:'storm',  name:'–ë–£–†–ï–í–ï–°–¢.', tag:'–õ–ï–ì–ï–ù–î–ê',  emoji:'‚ö°',body:'#7f8c8d',wing:'#636e72',head:'#dfe6e9',beak:'#fdcb6e',eye:'#6c5ce7',aura:'#fdcb6e', trail:'rgba(127,140,141,.5)'},
  {id:'ice',    name:'–õ–ï–î–Ø–ù–û–ô',   tag:'–ê–†–ö–¢–ò–ö–ê',  emoji:'‚ùÑÔ∏è',body:'#74b9ff',wing:'#0984e3',head:'#dfe6e9',beak:'#b2bec3',eye:'#111',  aura:'#74b9ff',  trail:'rgba(116,185,255,.5)'},
  {id:'golden', name:'–ó–û–õ–û–¢–û–ô',   tag:'–†–ï–î–ö–ò–ô',   emoji:'‚ú®',body:'#f1c40f',wing:'#e67e22',head:'#fffde7',beak:'#e67e22',eye:'#2d3436',aura:'#f1c40f', trail:'rgba(241,196,15,.6)'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CV = document.getElementById('c');
const CX = CV.getContext('2d');

// rrect ‚Äî –∑–∞–º–µ–Ω–∞ roundRect (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
// r –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º [tl,tr,br,bl]
function rrect(ctx,x,y,w,h,r){
  var tl,tr,br,bl;
  if(Array.isArray(r)){
    tl=r[0]||0; tr=r[1]||0; br=r[2]||0; bl=r[3]||0;
  } else {
    tl=tr=br=bl=r||0;
  }
  ctx.beginPath();
  ctx.moveTo(x+tl,y);
  ctx.lineTo(x+w-tr,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+tr);
  ctx.lineTo(x+w,y+h-br);
  ctx.quadraticCurveTo(x+w,y+h,x+w-br,y+h);
  ctx.lineTo(x+bl,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-bl);
  ctx.lineTo(x,y+tl);
  ctx.quadraticCurveTo(x,y,x+tl,y);
  ctx.closePath();
}


let W=0, H=0;

function resize(){
  W = CV.width  = window.innerWidth;
  H = CV.height = window.innerHeight;
  recalcPhysics();
  checkRotate();
}
window.addEventListener('resize', resize);
window.addEventListener('orientationchange', ()=>setTimeout(resize,250));

function checkRotate(){
  const mob = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  document.getElementById('rotate').style.display =
    (mob && window.innerHeight > window.innerWidth) ? 'flex' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –§–ò–ó–ò–ö–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let GRAV, JUMP, SPEED, GAP, PIPE_INT;
function recalcPhysics(){
  // sc –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ GAP –∏ PIPE_INT –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞,
  // –Ω–æ –ù–ï —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî –æ–Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
  const sc = Math.min(W, H*16/9) / 800;
  GRAV     = 0.15;          // –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–µ–∑–¥–µ, –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  JUMP     = -4.2;          // –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–µ–∑–¥–µ
  SPEED    = 2.2;           // –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–µ–∑–¥–µ, –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  GAP      = Math.max(160, 240*(H/450));   // –∑–∞–∑–æ—Ä –ø–æ–¥ –≤—ã—Å–æ—Ç—É —ç–∫—Ä–∞–Ω–∞
  PIPE_INT = Math.round(360/sc);           // —á–∞—Å—Ç–æ—Ç–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –°–û–°–¢–û–Ø–ù–ò–ï
// STATE: 'menu' | 'countdown' | 'ready' | 'playing' | 'over'
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let STATE = 'menu';
let birdIdx = 0;
let playerName = '–ò–ì–†–û–ö';

let bird, pipes, trails, particles;
let score, frame, combo, comboTimer;
let cycleDayNight = 0.55, lightFlash = 0;
let stars, clouds, mountains;

// –û—Ç—Å—á—ë—Ç ‚Äî —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —ç—Ç–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
let cdNum = 0;       // —Ç–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ 3/2/1
let cdTimer = null;  // handle setTimeout

// –ú–∏–≥–∞–Ω–∏–µ "tap to fly"
let tapBlink = 0;

// –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
let level = 1;
let lastLevelScore = 0;

// –ë–æ–Ω—É—Å—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ
let bonuses = [];
// –ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã –Ω–∞ –∏–≥—Ä–æ–∫–µ
let activeShield  = 0;  // –∫–∞–¥—Ä–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å
let activeGhost   = 0;  // –ø—Ä–æ—Ö–æ–¥ —Å–∫–≤–æ–∑—å —Ç—Ä—É–±—ã
let activeGun     = 0;  // —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ —Ç—Ä—É–±

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ç–∏—Ü
let unlockFlash     = 0;
let unlockFlashBird = 0;

// –¢—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞
let shakeDur   = 0;  // –∫–∞–¥—Ä–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å
let shakeAmp   = 0;  // –∞–º–ø–ª–∏—Ç—É–¥–∞
let activeSlow = 0;  // –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–ò–†–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initWorld(){
  recalcPhysics();
  bird = {x:W*0.22, y:H/2, v:0, wing:0};
  pipes=[];trails=[];particles=[];
  score=0; frame=0; combo=0; comboTimer=0; level=1; lastLevelScore=0;
  lightFlash=0; tapBlink=0; bonuses=[]; activeShield=0; activeGhost=0; activeGun=0; activeSlow=0; shakeDur=0; shakeAmp=0; unlockFlash=0;

  document.getElementById('hud-score').textContent = '0';
  document.getElementById('hud-combo').style.opacity = '0';
  document.getElementById('speedbar-fill').style.width = '0%';

  stars = Array.from({length:90},()=>({
    x:Math.random()*W, y:Math.random()*H*.65,
    r:.5+Math.random()*1.8, tw:Math.random()*Math.PI*2
  }));
  clouds = Array.from({length:7},()=>({
    x:Math.random()*W, y:30+Math.random()*H*.38,
    s:.5+Math.random()*.9, sp:.25+Math.random()*.35
  }));
  mountains = [0,1,2].map(li=>{
    const cnt=10+li*4;
    return {sp:(li+1)*.35, li,
      pts:Array.from({length:cnt+1},(_,i)=>({
        x:(W/cnt)*i,
        y:H*(.52+li*.13)-Math.random()*H*(.18-li*.04)
      }))
    };
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï DOM-–§–£–ù–ö–¶–ò–ò
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showEl(id){ document.getElementById(id).style.display='flex'; }
function hideEl(id){ document.getElementById(id).style.display='none'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clickPlay(){
  const nm = document.getElementById('inp-name').value.trim();
  playerName = nm || '–ò–ì–†–û–ö';
  beginCountdown();
}
function clickAnon(){
  playerName = '–ò–ì–†–û–ö';
  beginCountdown();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –û–¢–°–ß–Å–¢ 3-2-1 (—Ä–∏—Å—É–µ—Ç—Å—è –ù–ê CANVAS, –Ω–µ HTML)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function beginCountdown(){
  if(cdTimer) clearTimeout(cdTimer);
  hideEl('menu');
  hideEl('gameover');
  hideEl('hud');
  document.getElementById('speedbar').style.display = 'none';
  initWorld();
  cdNum = 3;
  STATE = 'countdown';
  scheduleNextTick();
}

function scheduleNextTick(){
  cdTimer = setTimeout(cdTick, 1000);
}

function cdTick(){
  cdNum--;
  if(cdNum > 0){
    scheduleNextTick();
  } else {
    // –û—Ç—Å—á—ë—Ç –∫–æ–Ω—á–∏–ª—Å—è ‚Üí STATE = ready
    cdTimer = null;
    STATE = 'ready';
    tapBlink = 0;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –£–ü–†–ê–í–õ–ï–ù–ò–ï
// –¢–∞–ø—ã/–∫–ª–∏–∫–∏/–ø—Ä–æ–±–µ–ª ‚Äî –¢–û–õ–¨–ö–û –Ω–∞ canvas
// –ù–∏–∫–∞–∫–∏—Ö HTML-–æ–≤–µ—Ä–ª–µ–µ–≤ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ canvas –≤ —Ä–µ–∂–∏–º–µ countdown/ready/playing
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onTap(e){
  if(e) e.preventDefault();

  if(STATE === 'countdown'){
    // –ù–∞–∂–∞—Ç–∏–µ –≤–æ –≤—Ä–µ–º—è –æ—Ç—Å—á—ë—Ç–∞ ‚Äî —É—Å–∫–æ—Ä—è–µ–º, –ø–µ—Ä–µ—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É –≤ ready
    if(cdTimer){ clearTimeout(cdTimer); cdTimer=null; }
    STATE = 'ready';
    tapBlink = 0;
    return;
  }

  if(STATE === 'ready'){
    // –ü–µ—Ä–≤—ã–π —Ç–∞–ø ‚Äî —Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã
    STATE = 'playing';
    frame = 0;
    showEl('hud');
    document.getElementById('speedbar').style.display = 'block';
    doFlap();
    return;
  }

  if(STATE === 'playing'){
    doFlap();
  }
}

function doFlap(){
  bird.v = JUMP;
  const b = BIRDS[birdIdx];
  for(let i=0;i<5;i++) particles.push({
    x:bird.x-12, y:bird.y+4,
    vx:-Math.random()*2.5, vy:(Math.random()-.5)*3,
    r:2+Math.random()*2, col:b.trail, life:1
  });
}

// –°–ª—É—à–∞–µ–º –¢–û–õ–¨–ö–û canvas ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–≤–µ—Ä—Ö –Ω–µ–≥–æ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
CV.addEventListener('touchstart', onTap, {passive:false});
CV.addEventListener('mousedown',  onTap);
window.addEventListener('keydown', e=>{
  if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); onTap(null); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–ù–û–ü–ö–ò GAME OVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clickAgain(){
  beginCountdown();
}
function clickMenu(){
  hideEl('gameover');
  initWorld();
  STATE = 'menu';
  showEl('menu');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ü–†–û–ì–†–ï–°–°–ò–Ø –°–õ–û–ñ–ù–û–°–¢–ò
// –ö–∞–∂–¥—ã–µ 10 –æ—á–∫–æ–≤ ‚Äî –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (–º–∞–∫—Å 10)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getDifficulty(){
  // level 1..10
  const lvl = Math.min(20, 1 + Math.floor(score / 5));
  const t = (lvl-1)/19; // 0..1

  return {
    lvl,
    // –°–∫–æ—Ä–æ—Å—Ç—å: –æ—Ç –±–∞–∑–æ–≤–æ–π –¥–æ +90%
    spd:  SPEED * (1 + t * 0.9) * (activeSlow>0 ? 0.45 : 1),
    // –ó–∞–∑–æ—Ä –º–µ–∂–¥—É —Ç—Ä—É–±–∞–º–∏: –æ—Ç GAP –¥–æ GAP*0.52 (–ø–æ—á—Ç–∏ –≤–¥–≤–æ–µ —É–∂–µ)
    gap:  GAP * (1 - t * 0.48),
    // –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ç—Ä—É–±–∞–º–∏: —á–∞—â–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è
    interval: Math.round(PIPE_INT * (1 - t * 0.35)),
    // –®–∏—Ä–∏–Ω–∞ —Ç—Ä—É–±: —á—É—Ç—å —Ç–æ–ª—â–µ
    pw: Math.max(60, Math.min(95, W*.09) * (1 + t * 0.25)),
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateGame(){
  bird.v += GRAV;
  bird.y += bird.v;
  bird.wing += .15;

  const diff = getDifficulty();

  // –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø—ã—à–∫—É
  if(diff.lvl > level){
    level = diff.lvl;
    lastLevelScore = score;
    // –°–≤–µ—Ç–æ–≤–∞—è –≤—Å–ø—ã—à–∫–∞
    lightFlash = 6;
  }

  // –¢—Ä—É–±—ã ‚Äî –ø–µ—Ä–≤–∞—è —á–µ—Ä–µ–∑ interval –∫–∞–¥—Ä–æ–≤ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
  if(frame > 0 && frame % diff.interval === 0){
    const minH = H*.1;
    const maxH = H - diff.gap - H*.1;
    const th = minH + Math.random() * Math.max(0, maxH - minH);
    pipes.push({x:W+10, w:diff.pw, h:th,             top:true,  passed:false});
    pipes.push({x:W+10, w:diff.pw, h:H-th-diff.gap,  top:false});
  }

  if(comboTimer>0) comboTimer--;
  else if(combo>0){ combo=0; updateComboUI(); }
  if(activeShield>0) activeShield--;
  if(activeGhost>0)  activeGhost--;
  if(activeGun>0)    activeGun--;
  if(activeSlow>0)   activeSlow--;
  if(shakeDur>0)     shakeDur--;
  updateBonuses();

  const br = Math.min(W,H)/520*9;

  for(let i=pipes.length-1; i>=0; i--){
    const p = pipes[i];
    p.x -= diff.spd;

    const py = p.top ? 0 : H-p.h;
    // Gun ‚Äî —É–Ω–∏—á—Ç–æ–∂–∞–µ–º —Ç—Ä—É–±—É –ø—Ä–∏ –∫–∞—Å–∞–Ω–∏–∏
    if(activeGun>0 && bird.x+br > p.x && bird.x-br < p.x+p.w){
      // –í–∑—Ä—ã–≤ —Ç—Ä—É–±—ã
      for(let ei=0;ei<8;ei++) particles.push({
        x:p.x+p.w/2, y:py+p.h/2,
        vx:(Math.random()-.5)*8, vy:(Math.random()-.5)*8,
        r:4+Math.random()*5, col:'#e74c3c', life:1
      });
      pipes.splice(i,1); continue;
    }
    // Ghost ‚Äî –ø—Ä–æ—Ö–æ–¥–∏–º —Å–∫–≤–æ–∑—å
    if(activeGhost>0){
      // —Ä–∏—Å—É–µ–º —Ç—Ä—É–±—É –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ ‚Äî –Ω–µ –∫–æ–ª–ª–∏–∑–∏—è
    } else if(bird.x+br > p.x && bird.x-br < p.x+p.w &&
       bird.y+br > py  && bird.y-br < py+p.h){
      if(activeShield>0){
        // –©–∏—Ç –ø–æ–≥–ª–æ—â–∞–µ—Ç —É–¥–∞—Ä
        activeShield=0;
        lightFlash=8;
        shakeDur=20; shakeAmp=6;
        pipes.splice(i,1); continue;
      }
      triggerDeath(); return;
    }

    if(!p.passed && p.top && p.x+p.w < bird.x){
      p.passed=true; score++;
      combo++; comboTimer=110;
      document.getElementById('hud-score').textContent = score;
      updateComboUI();
      spawnPts();
      // –°–ø–∏–¥–±–∞—Ä = –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è (0..100%)
      const progressInLevel = ((score % 5) / 5) * 100;
      document.getElementById('speedbar-fill').style.width = progressInLevel+'%';
      // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ç–∏—Ü: –∫–∞–∂–¥—ã–µ 50 —Ç—Ä—É–±
      const unl = getUnlocked();
      if(unl < BIRDS.length && score > 0 && score % 50 === 0){
        setUnlocked(unl+1);
        unlockFlash = 180; // 3 —Å–µ–∫—É–Ω–¥—ã
        unlockFlashBird = unl; // –∏–Ω–¥–µ–∫—Å –Ω–æ–≤–æ–π –ø—Ç–∏—Ü—ã
      }
      // –ë–æ–Ω—É—Å ‚Äî —Å–ª—É—á–∞–π–Ω–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ ~15 —Ç—Ä—É–±
      if(bonuses.length < 2 && Math.random() < 0.07){
        spawnBonus();
      }
    }
    if(p.x < -p.w-10) pipes.splice(i,1);
  }

  if(bird.y > H+20 || bird.y < -20) triggerDeath();

  if(Math.random()<.0012 && lightFlash<=0) lightFlash=10+Math.floor(Math.random()*8);
  if(lightFlash>0) lightFlash--;

  frame++;
}

function updateComboUI(){
  const el = document.getElementById('hud-combo');
  if(combo>=3){ el.style.opacity='1'; el.textContent='√ó'+combo+' –ö–û–ú–ë–û!'; }
  else el.style.opacity='0';
}

function spawnPts(){
  const cols=['#f1c40f','#e67e22','#2ecc71','#fff'];
  for(let i=0;i<7;i++) particles.push({
    x:bird.x, y:bird.y,
    vx:(Math.random()-.5)*5, vy:-Math.random()*4-1,
    r:3+Math.random()*4, col:cols[i%4], life:1
  });
}

function updateIdle(){
  bird.y = H/2 + Math.sin(frame*.05)*16;
  bird.v = Math.cos(frame*.05)*.8;
  bird.wing += .09;
  frame++;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –°–ú–ï–†–¢–¨
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function triggerDeath(){
  if(STATE==='over') return;
  STATE = 'over';
  // –¢—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞!
  shakeDur = 35;
  shakeAmp = 14;
  hideEl('hud');
  document.getElementById('speedbar').style.display='none';

  for(let i=0;i<24;i++) particles.push({
    x:bird.x, y:bird.y,
    vx:(Math.random()-.5)*11, vy:(Math.random()-.5)*11,
    r:4+Math.random()*8, col:['#e74c3c','#f1c40f','#fff'][i%3], life:1
  });

  const rec = saveScore(playerName, score, BIRDS[birdIdx].id);
  setTimeout(()=>showGameOver(rec), 900);
}

function showGameOver(rec){
  document.getElementById('go-score').textContent = score+' –û–ß–ö–û–í';
  document.getElementById('go-best').textContent =
    rec.isNew ? 'üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!' : ('–¢–≤–æ–π —Ä–µ–∫–æ—Ä–¥: '+rec.best);
  renderLB('lb-rows');
  showEl('gameover');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ï–ô–¢–ò–ù–ì
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LB_KEY   = 'buria_orlov_v1';
const UNL_KEY  = 'buria_orlov_unlocked'; // —Å–∫–æ–ª—å–∫–æ –ø—Ç–∏—Ü —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ

function getUnlocked(){
  return Math.max(1, parseInt(localStorage.getItem(UNL_KEY)||'1'));
}
function setUnlocked(n){
  localStorage.setItem(UNL_KEY, String(n));
}
function getLB(){ try{return JSON.parse(localStorage.getItem(LB_KEY)||'[]');}catch(e){return[];} }

function saveScore(name, s, birdId){
  let lb = getLB();
  const ei = lb.findIndex(e=>e.name.toLowerCase()===name.toLowerCase());
  let prev=0, isNew=false;
  if(ei>=0){ prev=lb[ei].s; if(s>prev){lb[ei]={name,s,birdId};isNew=true;} }
  else{ lb.push({name,s,birdId}); isNew=true; }
  lb.sort((a,b)=>b.s-a.s);
  lb=lb.slice(0,20);
  localStorage.setItem(LB_KEY, JSON.stringify(lb));
  return {best:Math.max(s,prev), isNew};
}

function renderLB(cid){
  const lb = getLB();
  const el = document.getElementById(cid);
  const ranks = ['ü•á','ü•à','ü•â','4.','5.','6.','7.','8.'];
  const me = playerName.toLowerCase();
  if(!lb.length){
    el.innerHTML='<div class="lb-row" style="opacity:.4;justify-content:center">–ù–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
    return;
  }
  el.innerHTML = lb.slice(0,6).map((e,i)=>{
    const isMe = e.name.toLowerCase()===me;
    const bd = BIRDS.find(b=>b.id===e.birdId)||BIRDS[0];
    return `<div class="lb-row${isMe?' lb-me':''}">
      <span class="lb-rank">${ranks[i]||i+1+'.'}</span>
      <span class="lb-icon">${bd.emoji}</span>
      <span class="lb-name${isMe?' me':''}">${esc(e.name)}</span>
      <span class="lb-pts">${e.s}</span>
    </div>`;
  }).join('');
}

function esc(s){
  return s.replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ò–°–û–í–ê–ù–ò–ï –§–û–ù–ê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function lp3(a,b,t){ return a.map((v,i)=>Math.round(v+(b[i]-v)*Math.max(0,Math.min(1,t)))); }

function drawSky(){
  const N=[[8,6,22],[12,10,35]], D=[[60,20,60],[100,30,80]],
        Y=[[28,95,185],[95,172,245]], S=[[75,28,18],[170,75,28]];
  let top,bot; const c=cycleDayNight;
  if(c<.25){const t=c/.25;       top=lp3(N[0],D[0],t);bot=lp3(N[1],D[1],t);}
  else if(c<.5){const t=(c-.25)/.25; top=lp3(D[0],Y[0],t);bot=lp3(D[1],Y[1],t);}
  else if(c<.75){const t=(c-.5)/.25;  top=lp3(Y[0],S[0],t);bot=lp3(Y[1],S[1],t);}
  else{const t=(c-.75)/.25;           top=lp3(S[0],N[0],t);bot=lp3(S[1],N[1],t);}
  if(lightFlash>0){const f=lightFlash/12;top=lp3(top,[230,235,255],f*.8);bot=lp3(bot,[190,210,255],f*.6);}
  const g=CX.createLinearGradient(0,0,0,H);
  g.addColorStop(0,`rgb(${top})`); g.addColorStop(1,`rgb(${bot})`);
  CX.fillStyle=g; CX.fillRect(0,0,W,H);
}

function drawStars(){
  const al=cycleDayNight<.3?1:cycleDayNight<.5?1-(cycleDayNight-.3)/.2:0;
  if(al<=0) return;
  stars.forEach(s=>{
    s.tw+=.035;
    CX.globalAlpha=al*(.4+Math.sin(s.tw)*.6);
    CX.fillStyle='#fff';
    if(s.r>0){CX.beginPath(); CX.arc(s.x,s.y,s.r,0,Math.PI*2); CX.fill();}
  });
  CX.globalAlpha=1;
}

function drawCelestial(){
  const sx=W*.82, c=cycleDayNight;
  const sy=H*.13+Math.sin(c*Math.PI*2)*H*.08;
  if(c>.18&&c<.82){
    const op=c<.28?(c-.18)/.1:c>.72?1-(c-.72)/.1:1;
    CX.globalAlpha=op;
    const sg=CX.createRadialGradient(sx,sy,0,sx,sy,55);
    sg.addColorStop(0,'rgba(255,255,195,1)'); sg.addColorStop(.45,'rgba(255,215,45,.75)'); sg.addColorStop(1,'rgba(255,140,0,0)');
    CX.fillStyle=sg; CX.beginPath(); CX.arc(sx,sy,55,0,Math.PI*2); CX.fill();
    CX.globalAlpha=1;
  } else {
    const ma=c<.1?1-c/.1:c>.9?(c-.9)/.1:1;
    CX.globalAlpha=Math.max(0,ma);
    CX.fillStyle='#ddeeff'; CX.beginPath(); CX.arc(sx,sy,20,0,Math.PI*2); CX.fill();
    CX.fillStyle='rgba(140,170,210,.55)'; CX.beginPath(); CX.arc(sx+7,sy-4,16,0,Math.PI*2); CX.fill();
    CX.globalAlpha=1;
  }
}

function drawMountains(){
  const c=cycleDayNight;
  const cols=[
    c<.5?lp3([18,28,55],[75,55,75],c*2):lp3([75,55,75],[38,18,28],(c-.5)*2),
    c<.5?lp3([13,22,45],[55,38,55],c*2):lp3([55,38,55],[28,13,22],(c-.5)*2),
    c<.5?lp3([8,16,35],[38,22,38],c*2) :lp3([38,22,38],[18,8,14],(c-.5)*2),
  ];
  mountains.forEach((m,li)=>{
    const spd=m.sp*(SPEED/3)*.14;
    m.pts.forEach(p=>p.x-=spd);
    if(m.pts[0].x<-W/m.pts.length*2){
      const last=m.pts[m.pts.length-1];
      m.pts.shift();
      m.pts.push({x:last.x+W/10,y:H*(.52+li*.13)-Math.random()*H*(.18-li*.04)});
    }
    CX.fillStyle=`rgb(${cols[li]})`;
    CX.beginPath(); CX.moveTo(0,H);
    m.pts.forEach(p=>CX.lineTo(p.x,p.y));
    CX.lineTo(W,H); CX.closePath(); CX.fill();
    if(li===0){
      CX.fillStyle=`rgba(255,255,255,${.12+c*.08})`;
      m.pts.forEach((p,i)=>{
        if(i===0||i===m.pts.length-1)return;
        CX.beginPath(); CX.moveTo(p.x-14,p.y+16); CX.lineTo(p.x,p.y); CX.lineTo(p.x+14,p.y+16); CX.closePath(); CX.fill();
      });
    }
  });
}

function drawClouds(){
  clouds.forEach(cl=>{
    cl.x-=cl.sp*(SPEED/3);
    if(cl.x<-180){cl.x=W+130;cl.y=30+Math.random()*H*.35;}
    CX.globalAlpha=.06+cycleDayNight*.11; CX.fillStyle='#fff';
    var cr1=Math.max(0,46*cl.s),cr2=Math.max(0,32*cl.s);
    [-1,0,1].forEach(d=>{ CX.beginPath(); CX.arc(cl.x+d*38*cl.s,cl.y,cr1,0,Math.PI*2); CX.fill(); });
    CX.beginPath(); CX.arc(cl.x,cl.y-22*cl.s,cr2,0,Math.PI*2); CX.fill();
    CX.globalAlpha=1;
  });
}

function drawPipes(){
  const night=cycleDayNight<.25||cycleDayNight>.75;
  pipes.forEach(p=>{
    const py=p.top?0:H-p.h;
    const rg=CX.createLinearGradient(p.x,0,p.x+p.w,0);
    if(night){rg.addColorStop(0,'#0b1824');rg.addColorStop(.5,'#162433');rg.addColorStop(1,'#081018');}
    else{rg.addColorStop(0,'#18182a');rg.addColorStop(.5,'#282840');rg.addColorStop(1,'#101020');}
    CX.fillStyle=rg;
    rrect(CX,p.x,py,p.w,p.h,p.top?[0,0,10,10]:[10,10,0,0]); CX.fill();
    const nc=night?'#3498db':'#7c4dff';
    CX.strokeStyle=nc; CX.lineWidth=2; CX.shadowBlur=night?14:6; CX.shadowColor=nc;
    rrect(CX,p.x,py,p.w,p.h,p.top?[0,0,10,10]:[10,10,0,0]); CX.stroke();
    CX.shadowBlur=0;
    CX.fillStyle=nc; CX.globalAlpha=.65;
    if(p.top) CX.fillRect(p.x,p.h-5,p.w,5); else CX.fillRect(p.x,H-p.h,p.w,5);
    CX.globalAlpha=1;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ò–°–û–í–ê–ù–ò–ï –û–¢–°–ß–Å–¢–ê –ò "TAP" –ù–ê CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawOverlayCanvas(){
  const cx=W/2, cy=H/2;

  if(STATE==='countdown'){
    // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
    CX.fillStyle='rgba(0,0,0,.45)';
    CX.fillRect(0,0,W,H);
    // –ë–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ
    const sz=Math.min(W,H)*.28;
    CX.font=`900 ${sz}px Arial, sans-serif`;
    CX.textAlign='center';
    CX.textBaseline='middle';
    // –¢–µ–Ω—å-—Å–≤–µ—á–µ–Ω–∏–µ
    CX.shadowBlur=60; CX.shadowColor='rgba(241,196,15,.9)';
    CX.fillStyle='#f1c40f';
    CX.fillText(String(cdNum), cx, cy);
    CX.shadowBlur=0;
    // –ü–æ–¥–ø–∏—Å—å –ø—Ç–∏—Ü—ã —Å–Ω–∏–∑—É
    const bdef=BIRDS[birdIdx];
    CX.font=`700 ${Math.min(W,H)*.04}px Arial, sans-serif`;
    CX.fillStyle='rgba(255,255,255,.55)';
    CX.fillText(bdef.emoji+' '+bdef.name, cx, cy+sz*.72);
    // –ú–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ–∫—Å—Ç ¬´–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª
    CX.font=`400 ${Math.min(W,H)*.025}px Arial, sans-serif`;
    CX.fillStyle='rgba(255,255,255,.25)';
    CX.fillText('–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å', cx, cy+sz*.72+Math.min(W,H)*.055);
    CX.textAlign='left'; CX.textBaseline='alphabetic';
    return;
  }

  if(STATE==='ready'){
    // –ú–∏–≥–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
    tapBlink += .05;
    const alpha = .45+Math.sin(tapBlink)*0.55;
    const fontSize = Math.min(W,H)*.055;
    const text = 'üëÜ  –ù–ê–ñ–ú–ò –ß–¢–û–ë–´ –õ–ï–¢–ï–¢–¨';
    CX.font=`700 ${fontSize}px Arial, sans-serif`;
    CX.textAlign='center';
    CX.textBaseline='middle';
    // –ü–ª–∞—à–∫–∞
    const tw=CX.measureText(text).width;
    const ph=fontSize*1.5, pw2=tw+fontSize*1.2;
    const bx=cx-pw2/2, by=cy-ph/2;
    CX.fillStyle=`rgba(0,0,0,${alpha*.65})`;
    rrect(CX,bx,by,pw2,ph,ph/2); CX.fill();
    CX.strokeStyle=`rgba(255,255,255,${alpha*.4})`;
    CX.lineWidth=1.5;
    rrect(CX,bx,by,pw2,ph,ph/2); CX.stroke();
    CX.globalAlpha=alpha;
    CX.fillStyle='#fff';
    CX.shadowBlur=18; CX.shadowColor='rgba(255,255,255,.6)';
    CX.fillText(text, cx, cy);
    CX.shadowBlur=0; CX.globalAlpha=1;
    // –ò–º—è –ø—Ç–∏—Ü—ã –ø–æ–¥ –Ω–∞–¥–ø–∏—Å—å—é
    const bdef=BIRDS[birdIdx];
    CX.font=`600 ${fontSize*.55}px Arial, sans-serif`;
    CX.fillStyle='rgba(255,255,255,.4)';
    CX.fillText(bdef.emoji+' '+bdef.name, cx, cy+fontSize*1.3);
    CX.textAlign='left'; CX.textBaseline='alphabetic';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –†–ò–°–û–í–ê–ù–ò–ï –ü–¢–ò–¶–´
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawBird(){
  const b=BIRDS[birdIdx];
  const sc=Math.min(W,H)/520;
  CX.save();
  CX.translate(bird.x,bird.y);
  const angle=Math.min(Math.PI/5,Math.max(-Math.PI/4,bird.v*.07));
  CX.rotate(angle);
  if(b.aura){CX.shadowBlur=18;CX.shadowColor=b.aura;}
  if(combo>=3){CX.shadowBlur=28;CX.shadowColor='#f1c40f';}
  CX.scale(sc,sc);
  const wf=Math.sin(bird.wing)*22;
  CX.fillStyle=b.wing;
  CX.beginPath(); CX.moveTo(-18,2); CX.quadraticCurveTo(0,-wf-24,18,2); CX.fill();
  CX.strokeStyle=b.body; CX.lineWidth=1; CX.globalAlpha=.4;
  for(let f=1;f<=3;f++){
    CX.beginPath(); CX.moveTo(-18+f*9,2);
    CX.quadraticCurveTo(-14+f*9,-wf*.5-f*3,-14+f*9,2); CX.stroke();
  }
  CX.globalAlpha=1;
  CX.fillStyle=b.body;
  CX.beginPath(); CX.ellipse(0,0,25,10,0,0,Math.PI*2); CX.fill();
  CX.fillStyle=b.head; CX.shadowBlur=0;
  CX.beginPath(); CX.arc(17,-4,10,0,Math.PI*2); CX.fill();
  CX.fillStyle=b.beak;
  CX.beginPath(); CX.moveTo(24,-4); CX.lineTo(36,-1); CX.lineTo(24,2); CX.fill();
  CX.fillStyle=b.eye;
  CX.beginPath(); CX.arc(20,-5,3,0,Math.PI*2); CX.fill();
  CX.fillStyle='#fff'; CX.beginPath(); CX.arc(21,-5.8,1.2,0,Math.PI*2); CX.fill();
  CX.fillStyle=b.wing;
  CX.beginPath(); CX.moveTo(-23,0); CX.lineTo(-35,-7); CX.lineTo(-27,3);  CX.fill();
  CX.beginPath(); CX.moveTo(-23,2); CX.lineTo(-33,10); CX.lineTo(-26,5);  CX.fill();
  CX.beginPath(); CX.moveTo(-23,1); CX.lineTo(-36,2);  CX.lineTo(-27,4);  CX.fill();
  if(b.id==='phoenix'){
    CX.globalAlpha=.7;
    ['#ff6b35','#f1c40f','#e74c3c'].forEach((col,ci)=>{
      CX.fillStyle=col;
      CX.beginPath();
      CX.moveTo(-23+ci*3,ci*2);
      CX.quadraticCurveTo(-30+ci*2,-9-Math.sin(frame*.14+ci)*7,-35+ci*3,-4+ci);
      CX.quadraticCurveTo(-28+ci,-2+Math.cos(frame*.14+ci)*4,-23+ci*3,ci*2);
      CX.fill();
    });
    CX.globalAlpha=1;
  }
  CX.restore();
  // –©–∏—Ç ‚Äî —Å–∏–Ω—è—è –∞—É—Ä–∞
  if(activeShield>0){
    CX.save();
    CX.strokeStyle='#3498db'; CX.lineWidth=3;
    CX.shadowBlur=20; CX.shadowColor='#3498db';
    CX.globalAlpha=0.6+Math.sin(frame*.15)*.4;
    const sc2=Math.min(W,H)/520;
    CX.beginPath(); CX.ellipse(bird.x,bird.y,32*sc2,18*sc2,0,0,Math.PI*2); CX.stroke();
    CX.shadowBlur=0; CX.globalAlpha=1;
    CX.restore();
  }
  // –ü—Ä–∏–∑—Ä–∞–∫ ‚Äî —Å–∏–Ω–µ–≤–∞—Ç–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (—Ä–∏—Å—É–µ—Ç—Å—è –≤—ã—à–µ, —Ç—É—Ç –Ω–∏—á–µ–≥–æ)
  // –ü—É—à–∫–∞ ‚Äî –∫—Ä–∞—Å–Ω–∞—è –∞—É—Ä–∞
  if(activeGun>0){
    CX.save();
    CX.strokeStyle='#e74c3c'; CX.lineWidth=2;
    CX.shadowBlur=16; CX.shadowColor='#e74c3c';
    CX.globalAlpha=0.5+Math.sin(frame*.2)*.5;
    const sc3=Math.min(W,H)/520;
    CX.beginPath(); CX.ellipse(bird.x,bird.y,38*sc3,22*sc3,0,0,Math.PI*2); CX.stroke();
    CX.shadowBlur=0; CX.globalAlpha=1;
    CX.restore();
  }
  trails.push({x:bird.x-10,y:bird.y,r:5,life:1});
  if(trails.length>20) trails.shift();
  trails.forEach(t=>t.life-=.06);
  trails=trails.filter(t=>t.life>0);
  trails.forEach(t=>{
    CX.globalAlpha=t.life*.45; CX.fillStyle=b.trail;
    var tr=t.r*t.life; if(tr>0){CX.beginPath(); CX.arc(t.x,t.y,tr,0,Math.PI*2); CX.fill();}
  });
  CX.globalAlpha=1;
}

function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=.08;
    p.life-=.03; p.r*=.96;
    if(p.life<=0){particles.splice(i,1);continue;}
    CX.globalAlpha=p.life; CX.fillStyle=p.col;
    if(p.r>0){CX.beginPath(); CX.arc(p.x,p.y,p.r,0,Math.PI*2); CX.fill();}
  }
  CX.globalAlpha=1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ü–¢–ò–¶–´ –í –ú–ï–ù–Æ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSelector(){
  const grid=document.getElementById('sel-grid');
  grid.innerHTML='';
  const unl = getUnlocked();
  // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –ø—Ç–∏—Ü–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞ 0
  if(birdIdx >= unl) birdIdx = 0;
  BIRDS.forEach((b,i)=>{
    const locked = i >= unl;
    const div=document.createElement('div');
    div.className='sel-card'+(i===0?' active':'')+(locked?' locked':'');
    div.style.cursor = locked ? 'default' : 'pointer';
    const cv=document.createElement('canvas'); cv.width=54; cv.height=54;
    const nm=document.createElement('div'); nm.className='cname'; nm.textContent=b.name;
    const tg=document.createElement('div'); tg.className='ctag';
    tg.textContent = locked ? 'üîí '+((i+1)*50)+' —Ç—Ä—É–±' : b.tag;
    div.append(cv,nm,tg);
    if(!locked){
      div.onclick=()=>{
        document.querySelectorAll('.sel-card').forEach(c=>c.classList.remove('active'));
        div.classList.add('active');
        birdIdx=i;
      };
    }
    grid.appendChild(div);
    drawPreview(b,cv,locked);
  });
}

function drawPreview(b,cv,locked){
  const c=cv.getContext('2d');
  if(locked) c.filter='blur(3px) brightness(0.3)';
  c.save(); c.translate(27,27);
  c.fillStyle=b.wing; c.beginPath(); c.moveTo(-14,0); c.quadraticCurveTo(0,-20,14,0); c.fill();
  c.fillStyle=b.body; c.beginPath(); c.ellipse(0,0,20,8,0,0,Math.PI*2); c.fill();
  c.fillStyle=b.head; c.beginPath(); c.arc(16,-4,9,0,Math.PI*2); c.fill();
  c.fillStyle=b.beak; c.beginPath(); c.moveTo(22,-4); c.lineTo(32,-1); c.lineTo(22,2); c.fill();
  c.fillStyle=b.eye;  c.beginPath(); c.arc(19,-5,2.5,0,Math.PI*2); c.fill();
  c.fillStyle='#fff'; c.beginPath(); c.arc(20,-5.5,1,0,Math.PI*2); c.fill();
  c.fillStyle=b.wing;
  c.beginPath(); c.moveTo(-20,0); c.lineTo(-30,-5); c.lineTo(-24,2); c.fill();
  c.beginPath(); c.moveTo(-20,2); c.lineTo(-28,8);  c.lineTo(-23,4); c.fill();
  if(b.aura){
    c.shadowBlur=12; c.shadowColor=b.aura;
    c.strokeStyle=b.aura; c.lineWidth=1.5;
    c.beginPath(); c.ellipse(0,0,21,9,0,0,Math.PI*2); c.stroke();
    c.shadowBlur=0;
  }
  c.restore();
  c.filter='none';
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ë–û–ù–£–°–´
// type: 'shield' | 'ghost' | 'gun' | 'slow'
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BONUS_DEFS = {
  shield: { icon:'üõ°', col:'#3498db', label:'–©–ò–¢',       dur:300 },
  ghost:  { icon:'üëª', col:'#9b59b6', label:'–ü–†–ò–ó–†–ê–ö',    dur:250 },
  gun:    { icon:'üí•', col:'#e74c3c', label:'–ü–£–®–ö–ê',      dur:200 },
  slow:   { icon:'‚è≥', col:'#2ecc71', label:'–ú–ï–î–õ–ï–ù–ù–û',   dur:280 },
};
const BONUS_TYPES = Object.keys(BONUS_DEFS);

function spawnBonus(){
  const type = BONUS_TYPES[Math.floor(Math.random()*BONUS_TYPES.length)];
  bonuses.push({
    x: W + 20,
    y: H*0.15 + Math.random()*H*0.7,
    type,
    r: Math.min(W,H)*0.032,
    pulse: Math.random()*Math.PI*2,
    life: 1,
  });
}

function updateBonuses(){
  const spd = getDifficulty().spd;
  const br  = Math.min(W,H)/520*9;

  for(let i=bonuses.length-1; i>=0; i--){
    const bo = bonuses[i];
    bo.x -= spd * 0.7;
    bo.pulse += 0.08;
    // –ü–æ–¥–æ–±—Ä–∞—Ç—å
    const dx = bird.x - bo.x, dy = bird.y - bo.y;
    if(Math.sqrt(dx*dx+dy*dy) < bo.r + br){
      collectBonus(bo.type);
      bonuses.splice(i,1);
      continue;
    }
    if(bo.x < -60) bonuses.splice(i,1);
  }
}

function collectBonus(type){
  const def = BONUS_DEFS[type];
  if(type==='shield') activeShield = def.dur;
  if(type==='ghost')  activeGhost  = def.dur;
  if(type==='gun')    activeGun    = def.dur;
  if(type==='slow'){
    // –∑–∞–º–µ–¥–ª—è–µ–º —Ç—Ä—É–±—ã –Ω–∞ –≤—Ä–µ–º—è
    activeShield = 0; // –Ω–µ –º–µ—à–∞–µ–º –¥—Ä—É–≥–∏–º
    activeGhost  = Math.max(activeGhost, def.dur); // –∏—Å–ø–æ–ª—å–∑—É–µ–º ghost –∫–∞–∫ slow-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    activeGhost  = 0;
    // —Ä–µ–∞–ª–∏–∑—É–µ–º slow —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–ª–∞–≥:
    activeSlow = def.dur;
  }
  // –ß–∞—Å—Ç–∏—Ü—ã –ø–æ–¥–±–æ—Ä–∞
  const def2 = BONUS_DEFS[type];
  for(let i=0;i<12;i++) particles.push({
    x:bird.x, y:bird.y,
    vx:(Math.random()-.5)*7, vy:(Math.random()-.5)*7,
    r:3+Math.random()*5, col:def2.col, life:1
  });
}

function drawBonuses(){
  bonuses.forEach(bo=>{
    const def = BONUS_DEFS[bo.type];
    const pulse = 1 + Math.sin(bo.pulse)*0.12;
    const r = bo.r * pulse;
    // –°–≤–µ—á–µ–Ω–∏–µ
    CX.save();
    CX.shadowBlur=20; CX.shadowColor=def.col;
    // –ö—Ä—É–≥ —Ñ–æ–Ω–∞
    CX.globalAlpha=0.35;
    CX.fillStyle=def.col;
    CX.beginPath(); CX.arc(bo.x,bo.y,r,0,Math.PI*2); CX.fill();
    CX.globalAlpha=0.7;
    CX.strokeStyle=def.col; CX.lineWidth=2;
    CX.beginPath(); CX.arc(bo.x,bo.y,r,0,Math.PI*2); CX.stroke();
    CX.shadowBlur=0;
    // –ò–∫–æ–Ω–∫–∞
    CX.globalAlpha=1;
    CX.font='bold '+Math.round(r*1.1)+'px Arial';
    CX.textAlign='center'; CX.textBaseline='middle';
    CX.fillText(def.icon, bo.x, bo.y);
    CX.textAlign='left'; CX.textBaseline='alphabetic';
    CX.restore();
  });
}

function drawActiveBonuses(){
  // –ü–æ–ª–æ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤ –ø–æ–¥ HUD
  const fs=Math.min(W,H)*.024;
  let yi=0;
  const drawBar=(type,remain,total)=>{
    if(remain<=0) return;
    const def=BONUS_DEFS[type];
    const x=14, y=fs*4.5+yi*(fs*1.8), bw=Math.min(W*.25,160), bh=fs*.9;
    CX.save();
    // –§–æ–Ω
    CX.fillStyle='rgba(0,0,0,.5)';
    CX.fillRect(x,y,bw,bh);
    // –ü—Ä–æ–≥—Ä–µ—Å—Å
    CX.fillStyle=def.col;
    CX.globalAlpha=0.8;
    CX.fillRect(x,y,bw*(remain/total),bh);
    CX.globalAlpha=1;
    // –ò–∫–æ–Ω–∫–∞ + —Ç–µ–∫—Å—Ç
    CX.font='700 '+fs*.85+'px Arial';
    CX.textBaseline='middle'; CX.fillStyle='#fff';
    CX.shadowBlur=4; CX.shadowColor='rgba(0,0,0,.8)';
    CX.fillText(def.icon+' '+def.label, x+4, y+bh/2);
    CX.shadowBlur=0;
    CX.restore();
    yi++;
  };
  drawBar('shield', activeShield, BONUS_DEFS.shield.dur);
  drawBar('ghost',  activeGhost,  BONUS_DEFS.ghost.dur);
  drawBar('gun',    activeGun,    BONUS_DEFS.gun.dur);
  drawBar('slow',   activeSlow,   BONUS_DEFS.slow.dur);
}

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ç–∏—Ü—ã ‚Äî –±–∞–Ω–Ω–µ—Ä —Å–Ω–∏–∑—É
function drawUnlockBanner(){
  if(unlockFlash<=0) return;
  unlockFlash--;
  const alpha=Math.min(1,unlockFlash/40)*Math.min(1,(unlockFlash>140?1:(unlockFlash/40)));
  const b=BIRDS[unlockFlashBird];
  const fs=Math.min(W,H)*.038;
  const text='üéâ –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–û: '+b.name+'!';
  CX.save();
  CX.globalAlpha=alpha;
  CX.fillStyle='rgba(0,0,0,.7)';
  CX.fillRect(0, H-fs*2.8, W, fs*2.8);
  CX.strokeStyle=b.aura||'#f1c40f'; CX.lineWidth=2;
  CX.strokeRect(0, H-fs*2.8, W, fs*2.8);
  CX.font='700 '+fs+'px Arial';
  CX.textAlign='center'; CX.textBaseline='middle';
  CX.fillStyle=b.aura||'#f1c40f';
  CX.shadowBlur=16; CX.shadowColor=b.aura||'#f1c40f';
  CX.fillText(text, W/2, H-fs*1.3);
  CX.shadowBlur=0;
  CX.textAlign='left'; CX.textBaseline='alphabetic';
  CX.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –£–†–û–í–ï–ù–¨ –ò LEVEL-UP –ù–ê CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawLevelHud(){
  if(STATE!=='playing' && STATE!=='over') return;

  const diff = getDifficulty();
  const fs = Math.min(W,H)*.028;

  // –£—Ä–æ–≤–µ–Ω—å ‚Äî –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª (–ø–æ–¥ –∫–æ–º–±–æ)
  CX.save();
  CX.textAlign='right';
  CX.textBaseline='top';
  CX.font='700 '+fs+'px Arial,sans-serif';

  // –¶–≤–µ—Ç —É—Ä–æ–≤–Ω—è: –∑–µ–ª—ë–Ω—ã–π‚Üí–∂—ë–ª—Ç—ã–π‚Üí–∫—Ä–∞—Å–Ω—ã–π
  const t=(level-1)/9;
  const r=Math.round(80+t*175), g=Math.round(220-t*120), b=80;
  const col='rgb('+r+','+g+','+b+')';

  CX.fillStyle='rgba(0,0,0,.4)';
  CX.fillRect(W-fs*5.5, fs*.5, fs*5, fs*1.6);

  CX.fillStyle=col;
  CX.shadowBlur=8; CX.shadowColor=col;
  CX.fillText('–£–†. '+level+' / 20', W-fs*.6, fs*.7);
  CX.shadowBlur=0;
  CX.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loop(){
  cycleDayNight=(cycleDayNight+.00035)%1;
  CX.clearRect(0,0,W,H);

  // –¢—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞
  CX.save();
  if(shakeDur>0){
    const sx=(Math.random()-.5)*shakeAmp*2;
    const sy=(Math.random()-.5)*shakeAmp*2;
    CX.translate(sx,sy);
    shakeAmp=Math.max(0,shakeAmp*.88);
  }

  // –§–æ–Ω —Ä–∏—Å—É–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ (–∫—Ä–∞—Å–∏–≤–æ –∑–∞ –º–µ–Ω—é —Ç–æ–∂–µ)
  drawSky();
  drawStars();
  drawCelestial();
  drawMountains();
  drawClouds();

  // –¢—Ä—É–±—ã ‚Äî —Ç–æ–ª—å–∫–æ –≤ –∏–≥—Ä–µ –∏ –ø–æ—Å–ª–µ —Å–º–µ—Ä—Ç–∏
  if(STATE==='playing'||STATE==='over') drawPipes();

  // –ü—Ç–∏—Ü–∞ + —á–∞—Å—Ç–∏—Ü—ã ‚Äî –≤—Å–µ–≥–¥–∞ –∫—Ä–æ–º–µ –º–µ–Ω—é
  if(STATE!=='menu'){
    if(STATE==='countdown'||STATE==='ready') updateIdle();
    if(STATE==='playing') updateGame();
    drawBird();
    drawBonuses();
    drawParticles();
    drawLevelHud();
    drawActiveBonuses();
    drawUnlockBanner();
    // –û—Ç—Å—á—ë—Ç/tap ‚Äî —Ä–∏—Å—É–µ–º –ù–ê canvas –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
    drawOverlayCanvas();
  }

  CX.restore(); // –∫–æ–Ω–µ—Ü —Ç—Ä—è—Å–∫–∏
  requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ó–ê–ü–£–°–ö
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
resize();
buildSelector();
initWorld();
loop(); // ‚Üê –∑–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª —Å—Ä–∞–∑—É
</script>
</body>
</html>
